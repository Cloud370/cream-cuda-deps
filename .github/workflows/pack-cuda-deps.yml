name: Pack CUDA Dependencies

on:
  workflow_dispatch:
    inputs:
      ort_version:
        description: "ONNX Runtime 版本"
        required: true
        default: "1.23.0"
      release_tag:
        description: "Release 标签"
        required: true
        default: "v1"

jobs:
  pack:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download ORT GPU package
        run: |
          ORT_VERSION="${{ inputs.ort_version }}"
          echo "下载 ONNX Runtime ${ORT_VERSION} GPU 包..."
          wget -q "https://github.com/microsoft/onnxruntime/releases/download/v${ORT_VERSION}/onnxruntime-win-x64-gpu-${ORT_VERSION}.zip" -O ort-gpu.zip
          unzip -q ort-gpu.zip -d ort-gpu

      - name: Extract ORT Provider DLLs
        run: |
          mkdir -p cuda-deps
          find ort-gpu -name "onnxruntime_providers_cuda.dll" -exec cp {} cuda-deps/ \;
          find ort-gpu -name "onnxruntime_providers_shared.dll" -exec cp {} cuda-deps/ \;
          echo "ORT Provider DLLs:"
          ls -lh cuda-deps/

      - name: Download NVIDIA CUDA wheels
        run: |
          pip download \
            nvidia-cuda-runtime-cu12 \
            nvidia-cublas-cu12 \
            nvidia-cufft-cu12 \
            nvidia-cudnn-cu12 \
            --only-binary=:all: \
            --platform win_amd64 \
            --python-version 3 \
            --no-deps \
            -d wheels/
          echo "Downloaded wheels:"
          ls -lh wheels/

      - name: Extract DLLs from wheels
        run: |
          python3 << 'PYEOF'
          import zipfile, os, shutil, glob

          PATTERNS = {
              "nvidia-cuda-runtime": ["cudart64"],
              "nvidia-cublas": ["cublas64", "cublasLt64"],
              "nvidia-cufft": ["cufft64"],
              "nvidia-cudnn": ["cudnn"],
          }

          for whl_path in glob.glob("wheels/*.whl"):
              whl_name = os.path.basename(whl_path).lower()
              with zipfile.ZipFile(whl_path) as z:
                  for name in z.namelist():
                      if not name.lower().endswith(".dll"):
                          continue
                      bn = os.path.basename(name)
                      for pkg_prefix, patterns in PATTERNS.items():
                          if pkg_prefix not in whl_name:
                              continue
                          if any(p.lower() in bn.lower() for p in patterns):
                              z.extract(name, "tmp_extract")
                              src = os.path.join("tmp_extract", name)
                              dst = os.path.join("cuda-deps", bn)
                              shutil.move(src, dst)
                              size_mb = os.path.getsize(dst) / 1048576
                              print(f"  提取: {bn} ({size_mb:.1f} MB)")
          PYEOF

      - name: Create zip
        run: |
          cd cuda-deps
          echo "=== DLL 列表 ==="
          ls -lh *.dll
          echo ""
          echo "总计: $(ls *.dll | wc -l) 个 DLL"
          zip ../cuda-deps-win64.zip *.dll
          cd ..
          echo ""
          echo "=== cuda-deps-win64.zip ==="
          ls -lh cuda-deps-win64.zip

      - name: Create Release and Upload
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          name: "CUDA Dependencies ${{ inputs.release_tag }} (ORT ${{ inputs.ort_version }})"
          body: |
            ONNX Runtime ${{ inputs.ort_version }} CUDA Provider + NVIDIA CUDA 12.x 运行库 DLL。
            用于 Cream 弹幕点歌机的 GPU 加速人声分离功能。

            包含:
            - onnxruntime_providers_cuda.dll + onnxruntime_providers_shared.dll
            - NVIDIA CUDA Runtime (cudart, cublas, cufft, cudnn)
          files: cuda-deps-win64.zip
